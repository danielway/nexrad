name: Rust CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_call:

jobs:
  formatting:
    name: Formatting check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          components: rustfmt
          system-deps: "false"
          cache: "false"

      - name: Check formatting
        run: cargo fmt --all -- --check

  clippy:
    name: Clippy linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          components: clippy

      - name: Run Clippy
        run: cargo clippy --all-features --workspace -- -D warnings

  build:
    name: Build check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: ./.github/actions/setup-rust

      - name: Install cargo-hack
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-hack

      - name: Check feature matrix
        run: cargo hack check --workspace --all-targets --each-feature --optional-deps --release

  documentation:
    name: Documentation check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: ./.github/actions/setup-rust

      - name: Install cargo-hack
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-hack

      - name: Check documentation feature matrix
        env:
          RUSTDOCFLAGS: "-D warnings"
        run: cargo hack doc --no-deps --each-feature --optional-deps --release

  examples:
    name: Example compilation check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: ./.github/actions/setup-rust

      - name: Build all examples
        run: cargo build --workspace --examples --all-features

  test:
    name: Test (${{ matrix.rust_version }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        rust_version: [stable, nightly]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          toolchain: ${{ matrix.rust_version }}

      - name: Run tests
        run: cargo test --all-features --workspace

  wasm-compatibility:
    name: WASM compatibility check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          targets: wasm32-unknown-unknown
          system-deps: "false"

      - name: Check nexrad-model (WASM)
        run: cargo check --target wasm32-unknown-unknown -p nexrad-model --all-features

      - name: Check nexrad-decode (WASM)
        run: cargo check --target wasm32-unknown-unknown -p nexrad-decode --all-features

      - name: Check nexrad-data without aws (WASM)
        run: cargo check --target wasm32-unknown-unknown -p nexrad-data --no-default-features

      - name: Check nexrad-data with aws (WASM)
        run: cargo check --target wasm32-unknown-unknown -p nexrad-data --no-default-features --features aws

      - name: Check nexrad facade with WASM-compatible features
        run: cargo check --target wasm32-unknown-unknown -p nexrad --no-default-features --features model,decode,data,aws,serde,uom,chrono
