name: Live NEXRAD Decode Test

on:
  schedule:
    # Run every Sunday at 6:00 AM UTC
    - cron: '0 6 * * 0'
  workflow_dispatch:

jobs:
  live-decode:
    name: Test ${{ matrix.site }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        site: [KDMX, KTLX, KLOT, KJAX, KATX]
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: ./.github/actions/setup-rust

      - name: Run live decode test for ${{ matrix.site }}
        env:
          TEST_SITE: ${{ matrix.site }}
        run: |
          cargo test --package nexrad-data --test live_decode test_live_decode_${{ matrix.site }} \
            --features aws -- --ignored --nocapture

  notify-failure:
    name: Create issue on failure
    runs-on: ubuntu-latest
    needs: live-decode
    if: failure()
    permissions:
      issues: write

    steps:
      - name: Create GitHub issue
        uses: actions/github-script@v7
        with:
          script: |
            const title = `Live decode test failure - ${new Date().toISOString().split('T')[0]}`;
            const body = `## Live Decode Test Failure

            The weekly live NEXRAD decode test failed on ${new Date().toISOString()}.

            **Workflow run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}

            Please investigate the failing site(s) and ensure the decoding logic handles current NEXRAD data correctly.

            This issue was automatically created by the live-decode workflow.`;

            // Check for existing open issue to avoid duplicates
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'live-decode-failure'
            });

            if (existingIssues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['live-decode-failure', 'bug']
              });
            } else {
              // Add a comment to existing issue instead
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssues.data[0].number,
                body: `Another failure occurred on ${new Date().toISOString()}.\n\n**Workflow run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
              });
            }
